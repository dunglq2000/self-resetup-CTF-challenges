

# This file was *autogenerated* from the file solve.sage
from sage.all_cmdline import *   # import sage library

_sage_const_0xfffffffffffffffffffffffffffffffffffffffffffffffffffffffefffffc2f = Integer(0xfffffffffffffffffffffffffffffffffffffffffffffffffffffffefffffc2f); _sage_const_0 = Integer(0); _sage_const_7 = Integer(7); _sage_const_0x79be667ef9dcbbac55a06295ce870b07029bfcdb2dce28d959f2815b16f81798 = Integer(0x79be667ef9dcbbac55a06295ce870b07029bfcdb2dce28d959f2815b16f81798); _sage_const_0x483ada7726a3c4655da4fbfc0e1108a8fd17b448a68554199c47d08ffb10d4b8 = Integer(0x483ada7726a3c4655da4fbfc0e1108a8fd17b448a68554199c47d08ffb10d4b8); _sage_const_0xfffffffffffffffffffffffffffffffebaaedce6af48a03bbfd25e8cd0364141 = Integer(0xfffffffffffffffffffffffffffffffebaaedce6af48a03bbfd25e8cd0364141); _sage_const_26 = Integer(26); _sage_const_2 = Integer(2); _sage_const_1 = Integer(1); _sage_const_48 = Integer(48); _sage_const_8 = Integer(8); _sage_const_35719 = Integer(35719); _sage_const_1337 = Integer(1337)
from pwn import *
from tqdm import tqdm
from parse import parse
from Crypto.Util.number import bytes_to_long
from hashlib import sha256

from sage.matrix.matrix2 import Matrix

def resultant(f1, f2, var):
	return Matrix.determinant(f1.sylvester_matrix(f2, var))

p = _sage_const_0xfffffffffffffffffffffffffffffffffffffffffffffffffffffffefffffc2f 
a = _sage_const_0 
b = _sage_const_7 
G = (_sage_const_0x79be667ef9dcbbac55a06295ce870b07029bfcdb2dce28d959f2815b16f81798 , _sage_const_0x483ada7726a3c4655da4fbfc0e1108a8fd17b448a68554199c47d08ffb10d4b8 )
n = _sage_const_0xfffffffffffffffffffffffffffffffebaaedce6af48a03bbfd25e8cd0364141 

E = EllipticCurve(GF(p), [a, b])
G = E(G)

def get_sig():
	conn.sendlineafter(b'choice? ', b'1')
	conn.recvline()
	x = list(parse('x = {:d}\n', conn.recvline().decode()))[_sage_const_0 ]
	s = list(parse('s = {:d}\n', conn.recvline().decode()))[_sage_const_0 ]
	return int(x), int(s)

def recover_d(x1, s1, x2, s2):
	l = _sage_const_26 
	ln = _sage_const_2 
	P = PolynomialRing(Zmod(n), [f'r{j}{i}' for j in range(ln) for i in range(l)] + ['d'])
	R, d = P.gens()[:l*ln], P.gens()[-_sage_const_1 ]
	k1 = sum(_sage_const_48 *_sage_const_2 **(_sage_const_8 *i) for i in range(l)) + sum(R[i]*_sage_const_2 **(_sage_const_8 *i) for i in range(l))
	k2 = sum(_sage_const_48 *_sage_const_2 **(_sage_const_8 *i) for i in range(l)) + sum(R[i+l]*_sage_const_2 **(_sage_const_8 *i) for i in range(l))
	f1 = s1*k1 - z - x1*d
	f2 = s2*k2 - z - x2*d
	f = resultant(f1, f2, d)
	M = matrix.column(ZZ, vector([int(c) for c,_ in f]))
	M = M.augment(matrix.identity(l*ln+_sage_const_1 ))
	M = M.stack(vector([n] + [_sage_const_0 ]*(l*ln+_sage_const_1 )))
	M = M.dense_matrix()
	M = M.BKZ()
	r_subs = {R[i]: abs(M[_sage_const_0 ][i+_sage_const_1 ]) for i in range(l*ln)}
	k1 = k1.subs(r_subs)
	k2 = k2.subs(r_subs)
	print(hex(k1))
	print(hex(k2))
	d = (s1 * k1 - z) * inverse_mod(x1, n) % n
	return d

conn = remote('localhost', _sage_const_35719 )

z = bytes_to_long(sha256(b'Baba').digest())
x1, s1 = get_sig()
x2, s2 = get_sig()

d = recover_d(x1, s1, x2, s2)
my_z = bytes_to_long(sha256(b'Flag').digest())
k = _sage_const_1337 
x, _ = (k*G).xy()
s = inverse_mod(k, n) * (my_z + int(x) * d) % n

conn.sendlineafter(b'choice? ', b'2')
conn.sendlineafter(b'know? ', b'Flag')
conn.sendlineafter(b'x? ', str(x).encode())
conn.sendlineafter(b's? ', str(s).encode())
print(conn.recvline().decode())

